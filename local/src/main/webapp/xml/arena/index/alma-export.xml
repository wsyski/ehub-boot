<?xml version="1.0" encoding="UTF-8"?>
<config format="alma-export">
	<index>
        <field name="contentProviderName">
            <query type="xquery"><![CDATA[
xquery version "1.0";
let $contentProviderName:=//exportCatalogueRecord/@contentProviderName
let $patterns:=(
'^https?://.+(elib)\.se(/library)?/ebook_detail\.asp\?(.*&amp;)?id=([^&amp;]+)(&amp;.*)?$',
'^https?://.+(publit)\.se/api/products/([^\.]+)$')
let $capturingGroups:=(1,1)
return
if (not(empty($contentProviderName))) then string($contentProviderName)
else
  (for $link in //view/externalUrls/externalUrl/@value
    for $pattern at $idx in $patterns
      return if (matches($link, $pattern, 'i')) then replace($link,$pattern, concat('$',$capturingGroups[$idx]), 'i') else ())[position() eq 1]
              ]]>
            </query>
        </field>
        <field name="contentProviderRecordId">
            <query type="xquery"><![CDATA[
xquery version "1.0";
let $contentProviderRecordId:=//exportCatalogueRecord/@contentProviderRecordId
let $patterns:=(
'^https?://.+(elib)\.se(/library)?/ebook_detail\.asp\?(.*&amp;)?id=([^&amp;]+)(&amp;.*)?$',
'^https?://.+(publit)\.se/api/products/([^\.]+)$')
let $capturingGroups:=(4,2)
return
if (not(empty($contentProviderRecordId))) then string($contentProviderRecordId)
else
  (for $link in //view/externalUrls/externalUrl/@value
    for $pattern at $idx in $patterns
      return if (matches($link ,$pattern, 'i')) then replace($link, $pattern, concat('$',$capturingGroups[$idx]), 'i') else ())[position() eq 1]
              ]]>
            </query>
        </field>
	</index>
</config>