<?xml version="1.0" encoding="UTF-8"?>
<config format="alma-export">
	<index>
        <field name="contentProviderName">
            <query type="xquery"><![CDATA[
xquery version "1.0";
let $contentProviderName:=//exportCatalogueRecord/@contentProviderName
let $patterns:=(
'^https?://.+(elib)\.se/library/ebook_detail\.asp\?(.*&amp;)?id=([^&amp;]+)(&amp;.*)?$',
'^https?://.+(publit)\.se/api/get-item/()([^\.]+)\.\w+\?(.*)?$')
return
if (not(empty($contentProviderName))) then string($contentProviderName)
else
  (for $link in //view/externalUrls/externalUrl/@value
    for $pattern in $patterns
      return if (matches($link,$pattern)) then replace($link,$pattern,'$1') else ())[position() eq 1]
              ]]>
            </query>
        </field>
        <field name="contentProviderRecordId">
            <query type="xquery"><![CDATA[
xquery version "1.0";
let $contentProviderRecordId:=//exportCatalogueRecord/@contentProviderRecordId
let $patterns:=(
'^https?://.+(elib)\.se/library/ebook_detail\.asp\?(.*&amp;)?id=([^&amp;]+)(&amp;.*)?$',
'^https?://.+(publit)\.se/api/get-item/()([^\.]+)\.\w+\?(.*)?$')
return
if (not(empty($contentProviderRecordId))) then string($contentProviderRecordId)
else
  (for $link in //view/externalUrls/externalUrl/@value
    for $pattern in $patterns
      return if (matches($link,$pattern)) then replace($link,$pattern,'$3') else ())[position() eq 1]
              ]]>
            </query>
        </field>
	</index>
</config>